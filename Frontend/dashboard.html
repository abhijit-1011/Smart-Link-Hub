<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Smart Link Hub</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#000;
      --card:#070707;
      --green:#00ff66;
      --text:#eaeaea;
      --muted:#9ca3af;
    }

    * { box-sizing: border-box; font-family: Inter, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }

    .navbar {
      display:flex;
      justify-content:space-between;
      padding:18px 30px;
      border-bottom:1px solid #111;
      align-items:center;
    }

    .navbar h2 { color:var(--green); margin:0; }

    .navbar button {
      background:transparent;
      border:1px solid var(--green);
      color:var(--green);
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      margin-left: 10px;
    }

    .container { max-width:1000px; margin:auto; padding:30px 20px; }
    h3 { color:var(--green); margin-bottom:12px; }

    .card {
      background:var(--card);
      border:1px solid #111;
      border-radius:14px;
      padding:20px;
      margin-bottom:28px;
    }

    input, select {
      width:100%;
      padding:12px;
      margin-bottom:10px;
      border-radius:8px;
      border:none;
      background:#111;
      color:var(--text);
    }

    input:focus, select:focus { outline:1px solid var(--green); }

    .btn {
      padding:10px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .btn-green { background:var(--green); color:#000; }

    .btn-red {
      background:transparent;
      border:1px solid red;
      color:red;
    }

    .link-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#050505;
      border:1px solid #111;
      border-radius:12px;
      padding:14px;
      margin-bottom:10px;
      gap: 12px;
    }

    .link-info h4 { color:var(--green); margin:0 0 4px; }
    .link-info p { color:var(--muted); font-size:0.85rem; margin: 2px 0; }

    .analytics {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
    }

    .stat {
      background:#050505;
      border:1px solid #111;
      border-radius:12px;
      padding:16px;
      text-align:center;
    }

    .stat h2 { color:var(--green); margin:0; }
    .stat p { color:var(--muted); margin:4px 0 0; }

    @media(max-width: 800px){
      .analytics { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<div class="navbar">
  <h2>Smart Link Hub – Dashboard</h2>
  <div>
    <button id="viewPublicBtn">View Public Hub</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="container">

  <!-- HUB SETTINGS -->
  <div class="card">
    <h3>Hub Settings</h3>

    <input id="hubTitle" placeholder="Hub Title">
    <input id="hubSlug" placeholder="Hub Slug (unique)">
    <select id="hubTheme">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
      <option value="neon">Neon</option>
    </select>

    <button class="btn btn-green" id="saveHubBtn">Save Hub</button>
    <p id="hubMsg" style="color: var(--muted); margin:8px 0 0;"></p>
  </div>

  <!-- ADD LINK -->
  <div class="card">
    <h3>Add Link</h3>

    <input id="linkTitle" placeholder="Link Title">
    <input id="linkUrl" placeholder="https://example.com">

    <button class="btn btn-green" id="addLinkBtn">Save Link</button>
    <p id="linkMsg" style="color: var(--muted); margin:8px 0 0;"></p>
  </div>

  <!-- LINKS -->
  <h3>Your Links</h3>
  <div id="linkList"></div>

  <!-- ANALYTICS OVERVIEW -->
  <div class="card">
    <h3>Analytics Overview</h3>

    <div class="analytics">
      <div class="stat">
        <h2 id="totalVisits">0</h2>
        <p>Total Hub Visits</p>
      </div>

      <div class="stat">
        <h2 id="totalClicks">0</h2>
        <p>Total Link Clicks</p>
      </div>

      <div class="stat">
        <h2 id="topLink">—</h2>
        <p>Top Performing Link</p>
      </div>
    </div>
  </div>

  <!-- ANALYTICS CARDS -->
  <div class="card">
    <h3>Clicks by Link</h3>
    <div id="analytics">Loading...</div>
  </div>

</div>


<script type="module">
import { supabase } from "./assets/js/supabase.js";

let user = null;
let currentHub = null;


// ---------------- INIT ----------------
async function init() {

  const { data } = await supabase.auth.getUser();
  user = data.user;

  if (!user) {
    location.href = "index.html";
    return;
  }

  await loadHub();
  await loadLinks();
  await loadAnalytics();
}



// ---------------- LOAD HUB ----------------
async function loadHub() {

  const { data, error } = await supabase
    .from("hubs")
    .select("*")
    .eq("user_id", user.id)
    .limit(1);

  if (error || !data.length) {
    document.getElementById("hubMsg").innerText =
      "Create your hub first.";
    return;
  }

  currentHub = data[0];

  hubTitle.value = currentHub.title || "";
  hubSlug.value = currentHub.slug || "";
  hubTheme.value = currentHub.theme || "dark";

  viewPublicBtn.onclick = () =>
    window.open(`hub.html?slug=${currentHub.slug}`, "_blank");
}



// ---------------- SAVE HUB ----------------
saveHubBtn.onclick = async () => {

  const title = hubTitle.value.trim();
  const slug  = hubSlug.value.trim();
  const theme = hubTheme.value;

  if (!title || !slug) {
    hubMsg.innerText = "Title & Slug required";
    return;
  }

  const { data, error } = await supabase
    .from("hubs")
    .upsert({
      user_id: user.id,
      title,
      slug,
      theme
    })
    .select();

  if (error) {
    hubMsg.innerText = error.message;
    return;
  }

  currentHub = data[0];
  hubMsg.innerText = "Saved";

  await loadAnalytics();
};



// ---------------- ADD LINK ----------------
addLinkBtn.onclick = async () => {

  if (!currentHub) return;

  const title = linkTitle.value.trim();
  const url   = linkUrl.value.trim();

  if (!title || !url) return;

  await supabase.from("links").insert({
    hub_id: currentHub.id,
    title,
    url,
    is_active: true
  });

  linkTitle.value = "";
  linkUrl.value = "";

  await loadLinks();
  await loadAnalytics();
};



// ---------------- LOAD LINKS ----------------
async function loadLinks() {

  if (!currentHub) return;

  const { data } = await supabase
    .from("links")
    .select("*")
    .eq("hub_id", currentHub.id);

  const list = document.getElementById("linkList");
  list.innerHTML = "";

  if (!data.length) {
    list.innerHTML = "<p style='color:#888'>No links yet</p>";
    return;
  }

  data.forEach(l => {

    const div = document.createElement("div");
    div.className = "link-item";

    div.innerHTML = `
      <div class="link-info">
        <h4>${l.title}</h4>
        <p>${l.url}</p>
      </div>
      <button class="btn btn-red">Delete</button>
    `;

    div.querySelector("button").onclick = async () => {
      await supabase.from("links").delete().eq("id", l.id);
      loadLinks();
      loadAnalytics();
    };

    list.appendChild(div);
  });
}



// ---------------- ANALYTICS ----------------
async function loadAnalytics() {

  if (!currentHub) return;


  // -------- VISITS --------
  const { data: visits } = await supabase
    .from("hub_visits")
    .select("id")
    .eq("hub_id", currentHub.id);

  document.getElementById("totalVisits").innerText =
    visits?.length || 0;



  // -------- CLICKS --------
  const { data: clicks } = await supabase
    .from("click_events")
    .select(`id, links ( title, hub_id )`);

  const filtered = (clicks || []).filter(
    c => c.links?.hub_id === currentHub.id
  );


  document.getElementById("totalClicks").innerText =
    filtered.length;


  // -------- TOP LINK --------
  const map = {};

  filtered.forEach(c => {
    const t = c.links?.title || "Unknown";
    map[t] = (map[t] || 0) + 1;
  });

  let top = "—", max = 0;

  for (const k in map) {
    if (map[k] > max) {
      max = map[k];
      top = k;
    }
  }

  document.getElementById("topLink").innerText = top;



  // -------- CARDS --------
  const box = document.getElementById("analytics");
  box.innerHTML = "";

  if (!filtered.length) {
    box.innerText = "No clicks yet";
    return;
  }

  for (const k in map) {

    const div = document.createElement("div");

    div.style.cssText =
      "background:#050505;border:1px solid #111;border-radius:12px;padding:14px;margin-bottom:10px;";

    div.innerHTML = `
      <strong style="color:var(--green)">${k}</strong>
      <p style="color:#aaa;margin-top:6px">
        Total Clicks: ${map[k]}
      </p>
    `;

    box.appendChild(div);
  }
}



// ---------------- LOGOUT ----------------
logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.href = "index.html";
};


init();
</script>

</body>
</html>
