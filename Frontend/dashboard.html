<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Smart Link Hub</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#000;
      --card:#070707;
      --green:#00ff66;
      --text:#eaeaea;
      --muted:#9ca3af;
    }

    * { box-sizing: border-box; font-family: Inter, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }

    /* NAVBAR */
    .navbar {
      display:flex;
      justify-content:space-between;
      padding:18px 30px;
      border-bottom:1px solid #111;
    }
    .navbar h2 { color:var(--green); }
    .navbar button {
      background:transparent;
      border:1px solid var(--green);
      color:var(--green);
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
    }

    .container { max-width:1000px; margin:auto; padding:30px 20px; }

    h3 { color:var(--green); margin-bottom:12px; }

    .card {
      background:var(--card);
      border:1px solid #111;
      border-radius:14px;
      padding:20px;
      margin-bottom:28px;
    }

    input, select {
      width:100%;
      padding:12px;
      margin-bottom:10px;
      border-radius:8px;
      border:none;
      background:#111;
      color:var(--text);
    }

    input:focus, select:focus {
      outline:1px solid var(--green);
    }

    .btn {
      padding:10px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .btn-green { background:var(--green); color:#000; }
    .btn-red {
      background:transparent;
      border:1px solid red;
      color:red;
    }

    /* LINK ITEM */
    .link-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#050505;
      border:1px solid #111;
      border-radius:12px;
      padding:14px;
      margin-bottom:10px;
    }

    .link-info h4 { color:var(--green); margin:0 0 4px; }
    .link-info p { color:var(--muted); font-size:0.85rem; }

    .analytics {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
    }

    .stat {
      background:#050505;
      border:1px solid #111;
      border-radius:12px;
      padding:16px;
      text-align:center;
    }

    .stat h2 { color:var(--green); margin:0; }
    .stat p { color:var(--muted); margin:4px 0 0; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<div class="navbar">
  <h2>Smart Link Hub – Dashboard</h2>
  <button onclick="location.href='hub.html'">View Public Hub</button>
</div>

<div class="container">

  <!-- HUB SETTINGS -->
  <div class="card">
    <h3>Hub Settings</h3>
    <input id="hubTitle" placeholder="Hub Title">
    <input id="hubDesc" placeholder="Hub Description">
    <select id="hubTheme">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
      <option value="neon">Neon</option>
    </select>
    <button class="btn btn-green" onclick="saveHub()">Save Hub</button>
  </div>

  <!-- ADD LINK -->
  <div class="card">
    <h3>Add / Edit Link</h3>
    <input id="linkTitle" placeholder="Link Title">
    <input id="linkUrl" placeholder="https://example.com">
    <input id="linkDesc" placeholder="Short Description">

    <!-- RULES -->
    <select id="ruleTime">
      <option value="">Time Rule (Optional)</option>
      <option value="work">Working Hours</option>
      <option value="night">Night Only</option>
    </select>

    <select id="ruleDevice">
      <option value="">Device Rule</option>
      <option value="mobile">Mobile</option>
      <option value="desktop">Desktop</option>
    </select>

    <select id="ruleCountry">
      <option value="">Country Rule</option>
      <option value="IN">India</option>
      <option value="US">USA</option>
    </select>

    <button class="btn btn-green" onclick="addLink()">Save Link</button>
  </div>

  <!-- LINKS -->
  <h3>Your Links</h3>
  <div id="linkList"></div>

  <!-- ANALYTICS -->
  <div class="card">
    <h3>Analytics Overview</h3>
    <div class="analytics">
      <div class="stat">
        <h2 id="totalVisits">0</h2>
        <p>Total Hub Visits</p>
      </div>
      <div class="stat">
        <h2 id="totalClicks">0</h2>
        <p>Total Link Clicks</p>
      </div>
      <div class="stat">
        <h2 id="topLink">—</h2>
        <p>Top Performing Link</p>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { supabase } from "./assets/js/supabase.js";

  let user;

  async function init() {
    const { data } = await supabase.auth.getUser();
    user = data.user;
    if (!user) location.href = "index.html";

    loadLinks();
    loadAnalytics();
  }

  async function saveHub() {
    await supabase.from("hubs").upsert({
      user_id: user.id,
      title: hubTitle.value,
      description: hubDesc.value,
      theme: hubTheme.value
    });
    alert("Hub saved");
  }

  async function addLink() {
    await supabase.from("links").insert({
      user_id: user.id,
      title: linkTitle.value,
      url: linkUrl.value,
      description: linkDesc.value,
      rule_time: ruleTime.value,
      rule_device: ruleDevice.value,
      rule_country: ruleCountry.value
    });
    loadLinks();
  }

  async function loadLinks() {
    const { data } = await supabase
      .from("links")
      .select("*")
      .eq("user_id", user.id)
      .order("clicks", { ascending:false });

    linkList.innerHTML = "";
    data.forEach(l => {
      const div = document.createElement("div");
      div.className = "link-item";
      div.innerHTML = `
        <div class="link-info">
          <h4>${l.title}</h4>
          <p>${l.url}</p>
          <p>Clicks: ${l.clicks || 0}</p>
        </div>
        <button class="btn btn-red" onclick="deleteLink('${l.id}')">Delete</button>
      `;
      linkList.appendChild(div);
    });
  }

  async function deleteLink(id) {
    await supabase.from("links").delete().eq("id", id);
    loadLinks();
  }

  async function loadAnalytics() {
    const { data } = await supabase.rpc("hub_analytics", { uid: user.id });
    totalVisits.innerText = data.visits;
    totalClicks.innerText = data.clicks;
    topLink.innerText = data.top_link || "—";
  }

  init();
</script>

</body>
</html>
